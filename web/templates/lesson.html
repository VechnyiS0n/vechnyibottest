<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ lesson.title }}</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Chart.js ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="top-bar">
    <h1>üìò {{ lesson.title }}</h1>
    <button id="theme-toggle">üåô</button>
</header>

<!-- ===== –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–∏—Ñ—Ä—ã ===== -->
<section class="stats">
    <div class="stat-card">
        <h3>üìù –í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫</h3>
        <p>{{ stats.total }}</p>
    </div>

    <div class="stat-card">
        <h3>‚≠ê –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</h3>
        <p>{{ stats.avg_rating|round(1) }}</p>
    </div>
</section>

<!-- ===== –ì—Ä–∞—Ñ–∏–∫–∏ ===== -->
<section class="analysis">

    <!-- –ì–†–ê–§–ò–ö 1: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ -->
    <div class="card">
        <h3>üìä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞</h3>
        <canvas id="moodChart"></canvas>
    </div>

    <!-- –ì–†–ê–§–ò–ö 2: –æ—Ü–µ–Ω–∫–∏ -->
    <div class="card">
        <h3>‚≠ê –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</h3>
        <canvas id="ratingChart"></canvas>
    </div>

    <!-- –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
    <div class="card">
        <h3>‚ùì –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>

        {% if questions %}
            <ul>
                {% for q in questions %}
                    <li>{{ q.text }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>–í–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endif %}
    </div>

</section>

<div class="back">
    <a href="{{ url_for('index') }}">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —É—Ä–æ–∫–æ–≤</a>
</div>

<footer>
    üîí –í—Å–µ –æ—Ç–∑—ã–≤—ã –∏ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–Ω–æ–Ω–∏–º–Ω–æ
</footer>

<script>
/* ===== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ===== */
const toggleBtn = document.getElementById("theme-toggle");

if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    toggleBtn.textContent = "‚òÄÔ∏è";
}

toggleBtn.onclick = () => {
    document.body.classList.toggle("dark");
    localStorage.setItem(
        "theme",
        document.body.classList.contains("dark") ? "dark" : "light"
    );
    toggleBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
};


/* ===== –ì–†–ê–§–ò–ö 1: –ö–†–£–ì–û–í–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê ===== */
new Chart(document.getElementById("moodChart"), {
    type: "pie",
    data: {
        labels: ["–ü–æ–Ω—è—Ç–Ω–æ üëç", "–°—Ä–µ–¥–Ω–µ üòê", "–ù–µ–ø–æ–Ω—è—Ç–Ω–æ üëé"],
        datasets: [{
            data: [
                {{ stats.like_count }},
                {{ stats.ok_count }},
                {{ stats.dislike_count }}
            ],
            backgroundColor: ["#22c55e", "#facc15", "#ef4444"]
        }]
    }
});


/* ===== –ì–†–ê–§–ò–ö 2: –°–¢–û–õ–ë–ß–ê–¢–´–ô ===== */
const ratingLabels = [];
const ratingCounts = [];

{% for row in rating_stats %}
    ratingLabels.push("{{ row.rating }} ‚≠ê");
    ratingCounts.push({{ row.count }});
{% endfor %}

new Chart(document.getElementById("ratingChart"), {
    type: "bar",
    data: {
        labels: ratingLabels,
        datasets: [{
            label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤",
            data: ratingCounts,
            backgroundColor: "#4a6cf7"
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
            }
        }
    }
});
</script>

</body>
</html>
