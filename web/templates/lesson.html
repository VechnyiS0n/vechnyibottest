<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>{{ lesson.title }}</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">

  <a class="back" href="/">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —É—Ä–æ–∫–æ–≤</a>

  <h1>{{ lesson.title }}</h1>
  <p class="muted">–ö–æ–¥ —É—Ä–æ–∫–∞: <b>{{ lesson.code }}</b></p>

  <!-- ===== –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===== -->
  <div class="card {% if stats.dislike_count > stats.like_count %}problem{% endif %}">
    <h2>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

    <p>–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤: <b>{{ stats.total or 0 }}</b></p>

    <p>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞:</p>
    <div class="rating-scale">
      {% for i in range(1, 6) %}
        <div class="rating-dot
          {% if stats.avg_rating and i <= stats.avg_rating|round(0, 'floor') %}
            active
          {% endif %}
        "></div>
      {% endfor %}
    </div>

    {% if stats.dislike_count > stats.like_count %}
      <p class="text-warning">
        –ú–∞—Ç–µ—Ä–∏–∞–ª –≤—ã–∑–≤–∞–ª –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏—è —É —á–∞—Å—Ç–∏ —É—á–µ–Ω–∏–∫–æ–≤.
      </p>
    {% else %}
      <p class="text-ok">
        –í —Ü–µ–ª–æ–º –º–∞—Ç–µ—Ä–∏–∞–ª –±—ã–ª –ø–æ–Ω—è—Ç–µ–Ω –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É —É—á–µ–Ω–∏–∫–æ–≤.
      </p>
    {% endif %}
  </div>

  <!-- ===== –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ ===== -->
  <div class="card">
    <h2>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞</h2>

    <div class="stats-inline">
      <span>üëç –ü–æ–Ω—è—Ç–Ω–æ: <b>{{ stats.like_count }}</b></span>
      <span>üòê –°—Ä–µ–¥–Ω–µ: <b>{{ stats.ok_count }}</b></span>
      <span>üëé –ù–µ–ø–æ–Ω—è—Ç–Ω–æ: <b>{{ stats.dislike_count }}</b></span>
    </div>

    {% if stats.total >= 1 %}
      <div class="chart-container">
        <canvas id="moodChart"></canvas>
      </div>
    {% else %}
      <p class="muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
    {% endif %}
  </div>

  <!-- ===== –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ ===== -->
  <div class="card">
    <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</h2>

    {% if rating_stats %}
      <div class="chart-container">
        <canvas id="ratingChart"></canvas>
      </div>
    {% else %}
      <p class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫</p>
    {% endif %}
  </div>

  <!-- ===== –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã ===== -->
  <div class="card">
    <h2>–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h2>
    <ul>
      {% for q in questions %}
        <li>{{ q.text }}</li>
      {% else %}
        <li class="muted">–ü–æ–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç</li>
      {% endfor %}
    </ul>
  </div>

  <!-- ===== –û—Ç–∑—ã–≤—ã ===== -->
<div class="card">
  <h2>–û—Ç–∑—ã–≤—ã –∏ –æ—Ü–µ–Ω–∫–∏</h2>

  <ul class="feedback-list">
    {% for c in comments %}
      <li class="feedback-item mood-{{ c.mood }}">
        <div class="feedback-header">
          <span class="mood-icon">
            {% if c.mood == "like" %}üëç
            {% elif c.mood == "ok" %}üòê
            {% elif c.mood == "dislike" %}üëé
            {% endif %}
          </span>

          <span class="rating">
            {{ c.rating }}/5
          </span>
        </div>

        <div class="feedback-text">
          {{ c.comment }}
        </div>
      </li>
    {% else %}
      <li class="empty">–ü–æ–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç</li>
    {% endfor %}
  </ul>
</div>


<footer>
  üîí –í—Å–µ –æ—Ç–∑—ã–≤—ã –∏ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–Ω–æ–Ω–∏–º–Ω–æ
</footer>

<script>
/* ===== –ì—Ä–∞—Ñ–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ===== */
{% if stats.total >= 1 %}
new Chart(document.getElementById("moodChart"), {
  type: "pie",
  data: {
    labels: [
      "–ü–æ–Ω—è—Ç–Ω–æ \uD83D\uDC4D",
      "–°—Ä–µ–¥–Ω–µ \uD83D\uDE10",
      "–ù–µ–ø–æ–Ω—è—Ç–Ω–æ \uD83D\uDC4E"
    ],
    datasets: [{
      data: [
        {{ stats.like_count }},
        {{ stats.ok_count }},
        {{ stats.dislike_count }}
      ],
      backgroundColor: ["#22c55e", "#facc15", "#ef4444"]
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: "top" }
    }
  }
});
{% endif %}

/* ===== –ì—Ä–∞—Ñ–∏–∫ –æ—Ü–µ–Ω–æ–∫ ===== */
{% if rating_stats %}
const ratingLabels = [];
const ratingCounts = [];

{% for row in rating_stats %}
ratingLabels.push("{{ row.rating }}");
ratingCounts.push({{ row.count }});
{% endfor %}

new Chart(document.getElementById("ratingChart"), {
  type: "bar",
  data: {
    labels: ratingLabels,
    datasets: [{
      label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤",
      data: ratingCounts,
      backgroundColor: "#4a6cf7"
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        ticks: { stepSize: 1 }
      }
    }
  }
});
{% endif %}
</script>

</body>
</html>
